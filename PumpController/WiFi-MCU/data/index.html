<html>
<head>
  <title>Water Pump Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src='jquery.min.js'></script>
  <script src='/main.js'></script>
</head>
<body>
  <h1>Water Pump Controller v%FIRMWARE%</h1>

  JSON output: <a href='/json/sensors'>Sensor</a>, <a href='/json/system'>System</a>  | <a href='/reset'>Reset settings</a>  | <a href='/reboot'>Reboot</a> | <a href='/update'>System Update</a>
  <br />

<div class="container">

  <div id="alarms"></div>

  <table id="table_main">
    <tr>
      <td id="table_main_td1">
        <table id="table_utility">
          <tr>
            <th colspan="2">Utility parameters</th>
          </tr>          
          <tr>
            <td class="td_title">
              Pump House Temp
            </td>
            <td class="td_value">
              <span id="temperature">%TEMPERATURE%</span>&nbsp;<sup class="units">&deg;C</sup>
            </td>
          </tr>
          <tr>
            <td class="td_title">
              Water Pressure
            </td>
            <td class="td_value">
              <span id="waterpressure">%WATERPRESSURE%</span> &nbsp;<sup class="units">bar</sup>
            </td>
          </tr>
          <tr>
            <td class="td_title">
              Mains V(rms) (L/N)
            </td>
            <td class="td_value">
              <span id="emon_vrms_L_N">-</span> <sup class="units">V</sup>
            </td>
          </tr>
          <tr>
            <td class="td_title">
              Phase V(rms) (L/PE)
            </td>
            <td class="td_value">
              <span id="emon_vrms_L_PE">-</span> <sup class="units">V</sup>
            </td>
          </tr>
          <tr>
            <td class="td_title">
              Phase V(rms) (N/PE)
            </td>
            <td class="td_value">
              <span id="emon_vrms_N_PE">-</span> <sup class="units">V</sup>
            </td>
          </tr>      
        </table>
      </td>

      <td id="table_main_td2">
        <table id="table_pump">
          <tr>
            <th colspan="2">Pump Parameters</th>
          </tr>
          <tr>
            <td  class="td_title">Status</td>
            <td class="td_value"> <span id="wp_is_running">-</span></td>
          </tr>
          <tr>
            <td class="td_title">Status duration</td>
            <td class="td_value"> <span id="wp_t_state">-</span></td>
          </tr>
          <tr>
            <td class="td_title">Suspended</td>
            <td class="td_value"> <span id="wp_is_suspended"></span> (<span id="wp_cnt_susp"></span> times)</td>
          </tr>
          <tr>
            <td class="td_title">Suspended duration</td>
            <td class="td_value"> <span id="wp_t_susp"></span></td>
          </tr>
          <tr>
            <td class="td_title">Starts #</td>
            <td class="td_value"> <span id="wp_cnt_starts">-</span></td>
          </tr>
          <tr>
            <td class="td_title">Total Runtime</td>
            <td class="td_value"> <span id="wp_t_totruntime">-</span></td>
          </tr>
        </table>              

        <hr />

        <table id="table_emon">
          <tr>
            <th>Circuit parameters</th>
          </tr>          
          <tr>
            <td>

              <table id="table_emon_circuits">
                <tr>
                  <th>Circuit</th>
                  <th>I(rms)</th>
                  <th>Power</th>
                  <th>PF</th>
                </tr>
                <tr>
                  <td>K2</td>
                  <td> <span id="emon_k2_irms">-</span> <sup class="units">A</sup></td>
                  <td> <span id="emon_k2_p_app">-</span> <sup class="units">W</sup></td>
                  <td> <span id="emon_k2_pf">-</span> <sup class="units">%</sup></td>
                </tr>
                <tr>
                  <td>K3</td>
                  <td> <span id="emon_k3_irms">-</span> <sup class="units">A</sup></td>
                  <td> <span id="emon_k3_p_app">-</span> <sup class="units">W</sup></td>
                  <td> <span id="emon_k3_pf">-</span><sup class="units">%</sup></td>
                </tr>      
              </table>
          
            </td>
          </tr>
        </table>
    
      </td>
    </tr>
  </table>

 
    <hr /> 

    <small>
      Uptime: <span id="uptime">-</span> - Free Heap memory: <span id="heap">-</span> Bytes - Freq: <span id="freq">-</span> - ChipID: <span id="chipid">-</span>
      <br /><br />
      Web Interface v2.38<br />
      <hr />Made by Ken-Roger Andersen, Dec 2020
    </small>
  </div>

  
</body>

<script src='/main.js'></script>

<script>
  jQuery(document).ready(function () {

    // Get sensor data from JSON
    setInterval(function ( ) {

      fetch('/json/sensors')
      .then(response => response.json())
      .then(data => {
          console.log(data);
          localStorage.setItem('json', JSON.stringify(data));
          } // data =>
      )
      .catch(error => {
          //console.error('Error:', error);
          json = JSON.parse('{"sensor":"pumphouse","id":"1","firmware":"2.01","pressure_bar":[3.771484],"temp_c":[26.65469],"alarms":[],"emon_vrms_L_N":235,"emon_vrms_L_PE":115,"emon_vrms_N_PE":105,"WP":{"t_state":430,"is_running":1,"is_suspended":false,"cnt_starts":2,"cnt_susp":2,"t_susp":0,"t_totruntime":1032},"K2":{"I":12.44595,"P_a":2862,"V":230,"PF":0},"K3":{"I":0,"P_a":0,"V":0,"PF":0}}');
          localStorage.setItem('json', JSON.stringify(json));
        }
      ); // fetch


    }, 3000 ) ;

    // Get system data from JSON
    setInterval(function ( ) {

      fetch('/json/system')
      .then(response => response.json())
      .then(data => {
          console.log(data);
          localStorage.setItem('jsonsystem', JSON.stringify(data));
          } // data =>
      )
      .catch(error => {
          //console.error('Error:', error);
          json = JSON.parse('{"ESP":{"heap":0,"freq":0,"chipid":123456,"uptimesecs":0}}');
          localStorage.setItem('jsonsystem', JSON.stringify(json));
        }
      ); // fetch


    }, 900 ) ;

    // Update the page
    setInterval(function ( ) {

      let json = JSON.parse(localStorage.getItem('json'));
      let jsonsystem = JSON.parse(localStorage.getItem('jsonsystem'));

      $("#temperature").empty().append(parseFloat(json.temp_c[0]).toFixed(1));
      $("#waterpressure").empty().append(parseFloat(json.pressure_bar[0]).toFixed(2));
      $("#wp_is_running").empty().append( json.WP.is_running ? "ON" : "OFF");
      $("#wp_is_suspended").empty().append( json.WP.is_suspended ? "YES" : "NO");
      $("#wp_t_state").empty().append( formatSecs(json.WP.t_state) );
      $("#wp_cnt_starts").empty().append( json.WP.cnt_starts );
      $("#wp_cnt_susp").empty().append( json.WP.cnt_susp );
      $("#wp_t_totruntime").empty().append( formatSecs(json.WP.t_totruntime) );
      $("#wp_t_susp").empty().append( formatSecs(json.WP.t_susp) );


      $("#emon_vrms_L_N").empty().append( parseFloat(json.emon_vrms_L_N).toFixed(1) );
      $("#emon_vrms_L_PE").empty().append( parseFloat(json.emon_vrms_L_PE).toFixed(1) );
      $("#emon_vrms_N_PE").empty().append( parseFloat(json.emon_vrms_N_PE).toFixed(1) );

      let emon_vrms_L_PE = json.emon_vrms_L_PE;
      let emon_vrms_N_PE = json.emon_vrms_N_PE;

      if(Math.abs(emon_vrms_N_PE - emon_vrms_L_PE) > 15.0) {
        $("#emon_vrms_L_PE").removeClass().addClass("ERR");
        $("#emon_vrms_N_PE").removeClass().addClass("ERR");
      } else {
        $("#emon_vrms_L_PE").removeClass().addClass("OK");
        $("#emon_vrms_N_PE").removeClass().addClass("OK");
      }
      


      $("#emon_k2_irms").empty().append( parseFloat(json.K2.I).toFixed(1) );
      $("#emon_k2_p_app").empty().append( json.K2.P_a );
      //$("#emon_k2_p_real").empty().append( json.K2.P_r );
      $("#emon_k2_pf").empty().append( json.K2.PF );

      $("#emon_k3_irms").empty().append(parseFloat(json.K3.I).toFixed(1) );
      $("#emon_k3_p_app").empty().append( json.K3.P_a );
      //$("#emon_k3_p_real").empty().append( json.K3.P_r );
      $("#emon_k3_pf").empty().append( json.K3.PF );

      $("#alarms").empty();
      if(Object.keys(json.alarms).length > 0) {
        $("#alarms").append("ALARMS: ");
        for(var key in json.alarms) {
          $("#alarms").append(json.alarms[key] + "&nbsp;");
        }
      }

      $("#uptime").empty().append( formatSecs(jsonsystem.ESP.uptimesecs) );
      $("#heap").empty().append( jsonsystem.ESP.heap );
      $("#freq").empty().append( jsonsystem.ESP.freq  + ' Mhz');
      $("#chipid").empty().append( jsonsystem.ESP.chipid );

    }, 500 ) ;

  }); // page loaded

</script>
</html>