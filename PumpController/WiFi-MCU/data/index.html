<html>
<head>
  <title>Home Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="cache-control" content="public, max-age=604800, immutable" />
  <meta http-equiv="last-modified" content="Tue, 05 Jan 2021 00:00:01 GMT" />
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
  <script src='main.js'></script>
</head>
<body>
  <h1>Home Controller v%FIRMWARE%</h1>

  JSON: <a href='/json/sensors'>Sensor</a>, <a href='/json/system'>System</a>  | <a href='/reset'>Reset settings</a>  | <a href='/reboot'>Reboot</a> | <a href='/update'>System Update</a>
 

<div class="container">

  <div id="alarms"></div>

  <table id="table_main">
    <tr>
      <td id="table_main_td1">
        <table id="table_utility">
          <tr>
            <th colspan="2">Power</th>
          </tr>          
          <tr>
            <td class="td_title">
              Mains V(rms) (L/N)
            </td>
            <td class="td_value">
              <span id="emon_vrms_L_N">-</span> <sup class="units">V</sup>/&nbsp;<span id="emon_freq">-</span> <sup class="units">Hz</sup>
            </td>
          </tr>
          <tr>
            <td class="td_title">
              Phase V(rms) (L/PE)
            </td>
            <td class="td_value">
              <span id="emon_vrms_L_PE">-</span> <sup class="units">V</sup>
            </td>
          </tr>
          <tr>
            <td class="td_title">
              Phase V(rms) (N/PE)
            </td>
            <td class="td_value">
              <span id="emon_vrms_N_PE">-</span> <sup class="units">V</sup>
            </td>
          </tr>      
        </table>

        <hr />

        <table id="table_emon">
          <tr>
            <th>Circuits</th>
          </tr>          
          <tr>
            <td>

              <table id="table_emon_circuits">
                <tr>
                  <th>Circuit</th>
                  <th>I(rms)</th>
                  <th>Power</th>
                  <th>PF</th>
                </tr>
                  <!-- <tbody> dynamically added by JS -->
              </table>
          
            </td>
          </tr>
        </table>

      </td>

      <td id="table_main_td2">
        <table id="table_pump">
          <tr>
            <th colspan="2">Water Pump</th>
          </tr>
          <tr style="font-size: 1.3em;">
            <td class="td_title">Water Pressure</td>
            <td class="td_value"><span id="waterpressure">%WATERPRESSURE%</span> &nbsp;<sup class="units">bar</sup></td>
          </tr>
          <tr>
            <td class="td_title">Pump House Temp</td>
            <td class="td_value"><span id="temperature">%TEMPERATURE%</span>&nbsp;<sup class="units">&deg;C</sup></td>
          </tr>          
          <tr>
            <td  class="td_title">Status</td>
            <td class="td_value"> <span id="wp_is_running">-</span></td>
          </tr>
          <tr>
            <td class="td_title">Status duration</td>
            <td class="td_value"> <span id="wp_t_state">-</span></td>
          </tr>
          <tr>
            <td class="td_title">Suspended</td>
            <td class="td_value"> <span id="wp_is_suspended"></span> (<span id="wp_cnt_susp"></span> times)</td>
          </tr>
          <tr>
            <td class="td_title">Suspended duration</td>
            <td class="td_value"> <span id="wp_t_susp"></span></td>
          </tr>
          <tr>
            <td class="td_title">Starts #</td>
            <td class="td_value"> <span id="wp_cnt_starts">-</span></td>
          </tr>
          <tr>
            <td class="td_title">Total Runtime</td>
            <td class="td_value"> <span id="wp_t_totruntime">-</span></td>
          </tr>
        </table>
    
      </td>
    </tr>
  </table>

    <hr /> 

    <small>
      Uptime: <span id="uptime">-</span> - Free Heap memory: <span id="heap">-</span> Bytes - Freq: <span id="freq">-</span> - ChipID: <span id="chipid">-</span>
      <br />
      Web Interface v%WEBIF_VERSION%<br />
      <hr />Made by %AUTHOR_TEXT%
    </small>
  </div>

  
</body>

<script>
  jQuery(document).ready(function () {

    // Get sensor data from JSON
    setInterval(function ( ) {

      fetch('/json/sensors')
      .then(response => response.json())
      .then(data => {
          //console.log(data);
          localStorage.setItem('json', JSON.stringify(data));
          } // data =>
      )
      .catch(error => {
          //console.error('Error:', error);
          json = JSON.parse('{"firmware":"2.11","pressure_bar":[0.000001],"temp_c":[0.00001],"alarms":[],"emon_freq":0.0000,"emon_vrms_L_N":0.0001,"emon_vrms_L_PE":0.0001,"emon_vrms_N_PE":0.001,"WP":{"t_state":0,"is_running":0,"is_suspended":false,"cnt_starts":0,"cnt_susp":0,"t_susp":0,"t_susp_tot":0,"t_totruntime":0},"circuits":{"K2":{"I":0.000001,"P_a":0,"PF":0},"K3":{"I":0.00001,"P_a":0,"PF":0}}}');
          //console.log(json);
          localStorage.setItem('json', JSON.stringify(json));
        }
      ); // fetch


    }, 3000 ) ;

    // Get system data from JSON
    setInterval(function ( ) {

      fetch('/json/system')
      .then(response => response.json())
      .then(data => {
          //console.log(data);
          localStorage.setItem('jsonsystem', JSON.stringify(data));
          } // data =>
      )
      .catch(error => {
          //console.error('Error:', error);
          json = JSON.parse('{"ESP":{"heap":0,"freq":0,"chipid":123456,"uptimesecs":0}}');
          localStorage.setItem('jsonsystem', JSON.stringify(json));
        }
      ); // fetch


    }, 900 ) ;

    // Update the page
    setInterval(function ( ) {

      //console.log(JSON.parse(localStorage.getItem('json')));
      let json = JSON.parse(localStorage.getItem('json'));
      let jsonsystem = JSON.parse(localStorage.getItem('jsonsystem'));

      $("#temperature").empty().append(parseFloat(json.temp_c[0]).toFixed(1));
      $("#waterpressure").empty().append(parseFloat(json.pressure_bar[0]).toFixed(2));
      $("#wp_is_running").empty().append( json.WP.is_running ? "ON" : "OFF");
      $("#wp_is_suspended").empty().append( json.WP.is_suspended ? "YES" : "NO");
      $("#wp_t_state").empty().append( formatSecs(json.WP.t_state) );
      $("#wp_cnt_starts").empty().append( json.WP.cnt_starts );
      $("#wp_cnt_susp").empty().append( json.WP.cnt_susp );
      $("#wp_t_totruntime").empty().append( formatSecs(json.WP.t_totruntime) );
      $("#wp_t_susp").empty().append( formatSecs(json.WP.t_susp) );

      $("#emon_freq").empty().append( parseFloat(json.emon_freq).toFixed(1) );
      $("#emon_vrms_L_N").empty().append( parseFloat(json.emon_vrms_L_N).toFixed(1) );
      $("#emon_vrms_L_PE").empty().append( parseFloat(json.emon_vrms_L_PE).toFixed(1) );
      $("#emon_vrms_N_PE").empty().append( parseFloat(json.emon_vrms_N_PE).toFixed(1) );

      let emon_vrms_L_N = json.emon_vrms_L_N;
      // Forsyningskrav i Norge er nominell spenning 230V +/- 10%
      if(emon_vrms_L_N > 253.0 || emon_vrms_L_N < 207.0) {
        $("#emon_vrms_L_N").removeClass().addClass("ERR");
      } else {
        $("#emon_vrms_L_N").removeClass().addClass("OK");
      }

      let emon_freq = json.emon_freq;
      if(Math.abs(50.0 - emon_freq) > 1.1) {
        $("#emon_freq").removeClass().addClass("ERR");
      } else {
        $("#emon_freq").removeClass().addClass("OK");
      }

      let emon_vrms_L_PE = json.emon_vrms_L_PE;
      let emon_vrms_N_PE = json.emon_vrms_N_PE;

      if(Math.abs(emon_vrms_N_PE - emon_vrms_L_PE) > 15.0) {
        $("#emon_vrms_L_PE").removeClass().addClass("ERR");
        $("#emon_vrms_N_PE").removeClass().addClass("ERR");
      } else {
        $("#emon_vrms_L_PE").removeClass().addClass("OK");
        $("#emon_vrms_N_PE").removeClass().addClass("OK");
      }
      
      // dynamically add table rows from json.circuits array
      if(Object.keys(json.circuits).length > 0) {
        $("#table_emon_circuits tbody").empty();
        for(var key in json.circuits) {
          markup ='<tr>'+
            '<td class="td_title">'+key+'</td>' +
            '<td class="td_value"><small>I(rms)</small> ' + parseFloat( json.circuits[key].I ).toFixed(1) + '<sup class="units_xs">A</sup></td>' +
            '<td class="td_value">' + json.circuits[key].P_a + '<sup class="units_xs">W</sup></td>' +
            '<td class="td_value"><small>PF:</small> ' + json.circuits[key].PF + '<sup class="units_xs">%</sup></td>' +
          '</tr>"';
          $("#table_emon_circuits tbody").append(markup);

        }
      }

      $("#alarms").empty();
      if(Object.keys(json.alarms).length > 0) {
        $("#alarms").append("ALARMS: ");
        for(var key in json.alarms) {
          $("#alarms").append(json.alarms[key] + "&nbsp;");
        }
      }

      $("#uptime").empty().append( formatSecs(jsonsystem.ESP.uptimesecs) );
      $("#heap").empty().append( jsonsystem.ESP.heap );
      $("#freq").empty().append( jsonsystem.ESP.freq  + ' Mhz');
      $("#chipid").empty().append( jsonsystem.ESP.chipid );

    }, 500 ) ;

  }); // page loaded

</script>
</html>