<html>
<head>
  <title>Water Pump Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src='jquery.min.js'></script>
</head>
<body>
  <h1>Water Pump Controller v%FIRMWARE%</h1>

  JSON output: <a href='/json/sensors'>Sensor</a>, <a href='/json/system'>System</a>  | <a href='/reset'>Reset settings</a>  | <a href='/update'>System Update</a>
  <br />

<div class="container">

  <div id="alarms"></div>

    <p>
      <span class="sensor-labels">Temperature</span>
      <span id="temperature">%TEMPERATURE%</span>
      <sup class="units">&deg;C</sup>
    </p>
    <p>
      <span class="sensor-labels">Water Pressure</span>
      <span id="waterpressure">%WATERPRESSURE%</span>
      <sup class="units">bar</sup>
    </p>

    <table>
      <tr>
        <th colspan="2">Pump Parameters</th>
      </tr>
      <tr>
        <td>Status</td>
        <td> <span id="wp_is_running">-</span></td>
      </tr>
      <tr>
        <td>Status duration</td>
        <td> <span id="wp_t_state">-</span></td>
      </tr>
      <tr>
        <td>Suspended</td>
        <td> <span id="wp_is_suspended"></span> (<span id="wp_cnt_susp"></span> times)</td>
      </tr>
      <tr>
        <td>Suspended duration</td>
        <td> <span id="wp_t_susp"></span></td>
      </tr>
      <tr>
        <td>Starts #</td>
        <td> <span id="wp_cnt_starts">-</span></td>
      </tr>
      <tr>
        <td>Total Runtime</td>
        <td> <span id="wp_t_totruntime">-</span></td>
      </tr>
    </table>

    <h4>EMON</h4>
    <table id="table_emon">
      <tr>
        <th>Circuit</th>
        <th>Irms</th>
        <th>Vrms</th>
        <th>Power (App/Real)</th>
        <th>PF</th>
      </tr>
      <tr class="tr_emon">
        <td>K2</td>
        <td> <span id="emon_k2_irms">-</span> A</td>
        <td> <span id="emon_k2_vrms">-</span> V</td>
        <td> <span id="emon_k2_p_app">-</span> W / <span id="emon_k2_p_real">-</span> W</td>
        <td> <span id="emon_k2_pf">-</span></td>
      </tr>
      <tr class="tr_emon">
        <td>K3</td>
        <td> <span id="emon_k3_irms">-</span> A</td>
        <td> <span id="emon_k3_vrms">-</span> V</td>
        <td> <span id="emon_k3_p_app">-</span> W / <span id="emon_k3_p_real">-</span> W</td>
        <td> <span id="emon_k3_pf">-</span></td>
      </tr>      
    </table>

    <hr /> 

    <small>
      Uptime: <span id="uptime">-</span> - Free Heap memory: <span id="heap">-</span> Bytes - Freq: <span id="freq">-</span> - ChipID: <span id="chipid">-</span>
      <br /><br />
      Web Interface v2.35<br />
      <hr />Made by Ken-Roger Andersen, Dec 2020
    </small>
  </div>

  
</body>
<script>
  
  function formatSecs(secs=0) {
    
    dateObj = new Date(secs * 1000); 
    days = Math.round(secs/86400);
    hours = dateObj.getUTCHours(); 
    minutes = dateObj.getUTCMinutes(); 
    seconds = dateObj.getSeconds(); 

    timeString = days.toString() + ' days, ' +  
    hours.toString().padStart(2, '0') 
        + ':' + minutes.toString().padStart(2, '0') 
        + ':' + seconds.toString().padStart(2, '0'); 
        
    return timeString;
  }

  jQuery(document).ready(function () {

    // Get sensor data from JSON
    setInterval(function ( ) {

      fetch('/json/sensors')
      .then(response => response.json())
      .then(data => {
          console.log(data);
          localStorage.setItem('json', JSON.stringify(data));
          } // data =>
      )
      .catch(error => {
          //console.error('Error:', error);
          json = JSON.parse('{"sensor":"pumphouse","id":"1","firmware":"2.01","pressure_bar":[3.966797],"temp_c":[25.67813],"alarms":[],"WP":{"t_state":32,"is_running":0,"is_suspended":false,"cnt_starts":0,"cnt_susp":1,"t_susp":0,"t_totruntime":0},"K2":{"I":29.6936,"P_a":0,"P_r":0,"V":230,"PF":0},"K3":{"I":21.15884,"P_a":0,"P_r":0,"V":230,"PF":0}}');
          localStorage.setItem('json', JSON.stringify(json));
        }
      ); // fetch


    }, 3000 ) ;

    // Get system data from JSON
    setInterval(function ( ) {

      fetch('/json/system')
      .then(response => response.json())
      .then(data => {
          console.log(data);
          localStorage.setItem('jsonsystem', JSON.stringify(data));
          } // data =>
      )
      .catch(error => {
          //console.error('Error:', error);
          json = JSON.parse('{"ESP":{"heap":0,"freq":0,"chipid":123456,"uptimesecs":0}}');
          localStorage.setItem('jsonsystem', JSON.stringify(json));
        }
      ); // fetch


    }, 900 ) ;

    // Update the page
    setInterval(function ( ) {

      let json = JSON.parse(localStorage.getItem('json'));
      let jsonsystem = JSON.parse(localStorage.getItem('jsonsystem'));

      $("#temperature").empty().append(parseFloat(json.temp_c[0]).toFixed(1));
      $("#waterpressure").empty().append(parseFloat(json.pressure_bar[0]).toFixed(2));
      $("#wp_is_running").empty().append( json.WP.is_running ? "ON" : "OFF");
      $("#wp_is_suspended").empty().append( json.WP.is_suspended ? "YES" : "NO");
      $("#wp_t_state").empty().append( formatSecs(json.WP.t_state) );
      $("#wp_cnt_starts").empty().append( json.WP.cnt_starts );
      $("#wp_cnt_susp").empty().append( json.WP.cnt_susp );
      $("#wp_t_totruntime").empty().append( formatSecs(json.WP.t_totruntime) );
      $("#wp_t_susp").empty().append( formatSecs(json.WP.t_susp) );

      $("#emon_k2_irms").empty().append( json.K2.I );
      $("#emon_k2_vrms").empty().append( json.K2.V );
      $("#emon_k2_p_app").empty().append( json.K2.P_a );
      $("#emon_k2_p_real").empty().append( json.K2.P_r );
      $("#emon_k2_pf").empty().append( json.K2.PF );

      $("#emon_k3_irms").empty().append( json.K3.I );
      $("#emon_k3_vrms").empty().append( json.K3.V );
      $("#emon_k3_p_app").empty().append( json.K3.P_a );
      $("#emon_k3_p_real").empty().append( json.K3.P_r );
      $("#emon_k3_pf").empty().append( json.K3.PF );

      $("#alarms").empty();
      if(Object.keys(json.alarms).length > 0) {
        $("#alarms").append("ALARMS: ");
        for(var key in json.alarms) {
          $("#alarms").append(json.alarms[key] + "&nbsp;");
        }
      }

      $("#uptime").empty().append( formatSecs(jsonsystem.ESP.uptimesecs) );
      $("#heap").empty().append( jsonsystem.ESP.heap );
      $("#freq").empty().append( jsonsystem.ESP.freq  + ' Mhz');
      $("#chipid").empty().append( jsonsystem.ESP.chipid );

    }, 500 ) ;

  }); // page loaded

</script>
</html>